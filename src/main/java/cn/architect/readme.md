记录，来自从0开始学架构。

三、复杂度来源：单台服务器变多台，单台负债均衡机器变多台(来源用户分配到不同负债均衡机，可DNS轮询、全局负债均衡器等)，多对多情况。这是在业务不变的情况下提升性能。
但若业务越来越负债，则单台服务器处理性能会产生瓶颈，就需要对业务的拆分了，比如微信拆分了漂流瓶、聊天等模块，并不是越细越好，不同模块之间调用的网络传输也占用了时间，比如1ms

换个角度看，其实可通过垂直和水平两个维度做高性能，垂直针对单台服务，软硬件提升，增加内存减少I/O，升级网络接口。
水平针对集群系统主要通过任务分配和任务分解提升。功能分解、多实例副本、数据分割比如MongoDB数据分片。

四、高可用来源：主要技术手段是服务与数据的冗余备份和失效转移。在于系统“无中断”，通过“冗余”解决，增加机器，或机房。通道可能故障，则用两条甚至三条(移动电信联通)。增加机器需要任务分配器，双机分配器算法常见的有主备(冷备、温备、热备)、主主。而还有高可用集群，分配算法有1主3备，2主2备...4主0备等，zookeeper是1主多备，memcached是全主0备。
    &emsp;计算高可用只需要加机器即可，存储高可用要考虑数据不一致问题。比如数据传输，尤其是跨机房，带来的延迟以及网络异常情况。也是CAP定理，即一致性、可用性、分区容错性，最多同时满足两个。
    &emsp;冗余的高可用系统，状态决策相当重要，而一般有几种类型，独裁式(决策者本身可能有问题)、协商式(比如主备通信，协商选决策者。主备之间可能连接中断导致信息交换失败)、民主式(比如zookeeper集群通过多个独立个体投票进行状态决策，多数取胜，算法Paxos。另外也会有脑裂问题，即多决策者)，记得和朋友聊过，还可以通过每间隔一段时间争抢缓存锁(缓存值有过期时间)来选主。
    
    硬件故障引起的技术解决措施：1应用服务器(实现业务逻辑)，通过负载均衡构建集群(这些服务需要为无状态、即应用服务器不保存业务上下文)，通过心跳监控是否服务正常，不正常则剔除。2服务层服务器，一般通过rpc提供服务(例如dubbo)，给应用服务调用。3数据服务器，需在数据写入时进行数据同步复制，将数据写入多台服务器，实现冗余备份，当数据服务器宕机，应用程序切换到有备份的机器。
    软件一起的不可用解决措施：通过开发流程进行保证。比如通过预发布验证、测试、灰度发布等。

五、复杂度之可扩展性:在技术上，方案1将可能变化部分设计成变化层、不变层另外设计.方案2提炼出一个“抽象层”和一个实现层。
实际解决方案：1使用分布式服务框架构建可复用的业务平台(如dubbo拆分模块)，2使用分布式消息队列降低业务模块间的耦合性。

六、复制度之低成本-安全-规模:一般低成本，伴随着引入新技术或自创新技术了，比如Nosql出现是为了解决关系型数据库无法应对的高并发访问带来的访问压力，全文搜索引擎(es、solr等)是为了解决关系型数据库like搜索的低效问题，Hadoop是为了解决传统文件系统无法应对海量数据存储和计算的问题。新浪微博将传统的redis/mc+mysql扩展为redis/mc+ssd cache+mysql，解决redis成本过高和容量小问题，也解决了穿透DB带来的数据库访问压力。linkedin为处理5千亿事件，开发高效kafka。安全方面，像ddos攻击，一般通过运营商或云服务商提高带宽和流量清洗能力解决。
另外，画图方面，架构图推荐4+1画图。

14、数据库集群-读写分离：主从延迟和分配机制，<br>
    &emsp;首先复制延迟常见方案，(1)写后的读操作发给主，业务代码侵入。（2）读从机失败后读主，二次读取容易造成主压力大。（3）关键业务读写都在主，非关键业务用读写分离。其实也可通过缓存redis来解决<br>
    &emsp;分配机制有两种，程序代码封装和中间件封装。比如程序代码可在hibernate封装一层实现，以及成熟的TDDL，但每种语言要各自实现一份，且主从切换，可能要修改配置并重启服务。而中间件是数据库管理，能支持多种语言，主从动态切换，比如MySQL Router。

15、数据库分库分表：垂直分、水平分。<br>
    &emsp;路由规则，可通过路由表，也可以hash路由。<br>
    &emsp;其中join操作可通过分别每个库表操作，再汇总。<br>
    &emsp;而count也同理，比如文章的总数，用来分页，也可通过加一个冗余字段记录每个库表的count数量，但会有数据一致性问题。<br>
    &emsp;另外，分库分表业务实现，也同样是“程序代码封装”和“中间件封装”两种。根据sql具体的表名、函数名(例如sum函数)，分别执行并汇总。<br>
    
16、NoSQL:常见的分为4类，<br>
    &emsp;K-V存储：解决关系数据库无法存储数据结构的问题，redis为代表。含有string、hash、list、set、sorted set等结构。<br>
    &emsp;文档数据库：解决关系数据库强schema约束的问题，MongoDB为代表。特点是no-ch<br>
    &emsp;列式数据库：解决关系数据库大数据场景下I/O问题，HBase为代表。<br>
    &emsp;全文搜索引擎：解决关系数据库的全文搜索性能问题，Elasticsearch为代表。<br>
    &emsp;其中，Elasticsearch等搜索引擎建立索引时，分为正排索引和倒排索引，个人理解是，先通过倒排去找到需要的文档编号，再通过正排根据文档编号找对应信息。<br>
    &emsp;正排：相当于一个网页拆分成多个关键词，比如网页A=关键词1+关键词2+关键词3+关键词4+关键词5+关键词6+关键词7+......,即Doc1: [Term1, Pos1], [Term2, Pos2], ...。易维护；缺点是搜索的耗时太长；<br>
    &emsp;倒排：相当于一个关键词对应多个网页，比如关键词1=网页A+网页B+网页C+网页O+....，即Term1: [Doc1, Pos1], [Doc2, Pos2], ...。与正排刚好相反。<br>
    
17、高性能缓存架构：memcache单台可达TPS 5万以上。<br>
    &emsp;缓存穿透有两种情况，1是存储的数据不存在，导致每次要去db验证一下，可通过设置默认值，比如null来解决；2是缓存数据需要耗费大量时间生成，比如一些列表展示内容(像商品列表)，一般只缓存前几页，但爬虫可能会爬所有的，导致缓存速度跟不上，可以通过监控及时处理。<br>
    &emsp;缓存雪崩一般指缓存失效(自动过期)后引起系统性能急剧下降的情况。缓存失效，且生成时，对于一个高并发系统，可能会有多个线程取值导致性能压力；可通过更新锁机制或后台更新机制解决。
    &emsp;缓存热点一般指热点数据，复制多份缓存副本，将请求分散到多个副本上，减轻单台压力，另外每个副本的过期时间不要统一，防止缓存同时失效的情况。
    
18、单服务器高性能模式-PPC和TPC模式，

19、

20、高性能负债均衡，分类与架构：DNS负载均衡，用来实现地理级别，比如根据网址解析到不同的机房ip。硬件负载均衡，F5和A10等，比较贵，F5可支持200—~800万/s级别。软件负载均衡，常见的有Nginx（5万/s）、LVS（80万/）等，nginx是7层，支持http、e-mail协议，lvs是4层，和协议无关，基本所有应用都能做，像聊天、数据库。
另外，可阅读http://1181731633.iteye.com/admin/blogs/2427323

22、CAP定理：P要求分布式和数据同步，C要求数据完全一致，A要求返回及时。<br>
第一版：分布式系统不能同时满足一致性C、可用性A、分区容错性P三个设计约束。一致性强调所有节点同一时刻看(**see**)到相同数据。可用性指每个请求都能成功或失败的响应。分区容错性指出现消息丢失(消息丢失指丢包，消息丢失可造成分区)或者分区(丢包、网络连接中断、拥塞等原因造成，节点问题导致超时，节点宕机不属于)错误时系统能够继续运行。<br>
第二版：在一个分布式系统中(**互相连接并共享数据的节点集合**)，当设计**读写**操作时，只能保证一致性、可用性、分区容错性中的两个，另外一个必须牺牲。memcache集群相互之间没有连接和共享数据，mysql是。一致性指对于某个指定的客户端，读操作保证能够返回最新的写操作结果。可用性指**非故障的节点**在合理的时间内返回合理的响应(不是错误和超时响应)。分区容错性指出现网络分区后，系统能够继续履行职责，即可运转返回有效的响应。<br>
    &emsp;分布式环境，必须选P，因为网络无法完全可靠。假如发生分区，为了保证C，系统需要禁止写入，当有写入要求是，系统返回error，这时候就与A冲突了，因为A要求返回no error和no timeout。而PC时，当发生分区，为了保证数据一致，一部分未被同步的节点需要返回error，就废弃了A。而PA时，发生分区时，不同节点的数据不一致，但是可正常返回服务(可能返回旧数据)，就废弃了C，比如订单支付后，已经有支付记录了，但是还没有读取支付情况并更新订单状态。<br>
    &emsp;zookeeper中，paxos属于CP，因为多数派分区可以保持一致性，少数派无法完成操作，就缺失了A。<br>
    &emsp;CAP理论忽略延时，只有网络通，数据一致。其实实际机构需要考虑延时问题。一般实际项目中，CP比较多<br>

25、高可用双机存储架构：常见高可用存储架构有主备、主从、主主、集群、分区。<br>
    &emsp;主备复制，备机只做备份，不承担业务读写，如需要备改为主，需要人工。基本所有存储系统都提供了主备复制功能，例如MYSQL、Redis、MongoDB等。<br>
    &emsp;主从复制，从负责读，不负责写。与主备主要区别在于正常情况下，从机也需要提供读操作。但缺点是客户端需要感知主从关系，并将不同操作发给不同的机器进行处理。且复制延迟比较大时，业务可能因为数据不一致而出现问题。适用于读多写少，像论坛、BBS、新闻网站等。<br>
    &emsp;双机切换，上述两种方案，在主宕机或问题时，需要人工干预，双机切换是为了弥补上述两种方案的不足。包括主备切换、主从切换。1）根据状态传递渠道不同，架构有三种形式：互连式(建立状态传输通道)、中介式(zookeeper和keeplived)、模拟式(备向主发起模拟读写请求获取状态)。<br>
    &emsp;主主复制，两台机都是主机，互相将数据复制给对方，客户端可任意选择其中一台进行读写。容易造成数据不一致，比如不同主机的id冲突，库存被覆盖。<br>
    
26、高可用集群和分区存储架构：集群分为数据集中集群(即一主多从)、数据分散集群（分片）。<br>
    &emsp;数据分散集群，分区规则可按国家分区、城市分区等，而数据分区，当某地区发生灾难，数据可能丢失，所以需要复制备份，复制规则包括集中式、互备式、独立式。集中式指有一个总的备份中心，所有分区数据都备份到备份中心；互备式指每个分区备份另外一个分区的数据，这样可避免不全部丢失，但扩展麻烦；独立式指每个分区有自己的独立备份中心，但注意独立备份中心和分区数据并不在一个地区，保证数据的安全性。
    
